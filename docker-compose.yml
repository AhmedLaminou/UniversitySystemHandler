services:
  # ---------------------------
  # DATABASES
  # ---------------------------
  mongodb:
    image: mongo:6.0
    container_name: soa-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - soa-network

  postgres:
    image: postgres:15
    container_name: soa-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: grade_user
      POSTGRES_PASSWORD: grade_pass
      POSTGRES_DB: grade_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./services/postgres-init:/docker-entrypoint-initdb.d
    networks:
      - soa-network

  mysql:
    image: mysql:8.0
    container_name: soa-mysql
    ports:
      - "3307:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: billing_db
      MYSQL_USER: billing_user
      MYSQL_PASSWORD: billing_pass
    volumes:
      - mysql_data:/var/lib/mysql
      # Initialise les bases auth_db et billing_db et droits utilisateurs
      - ./services/mysql-init:/docker-entrypoint-initdb.d
    networks:
      - soa-network

  # ---------------------------
  # MICROSERVICES
  # ---------------------------
  student-service:
    build: ./services/student-service
    container_name: soa-student-service
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      MONGODB_URI: mongodb://mongodb:27017/student_db
      JWT_SECRET: MyVerySecureSecretKeyForAuthenticationJWTTokens2024WithEnoughCharacters
      AUTH_SERVICE_URL: http://auth-service:8080
    depends_on:
      - mongodb
    networks:
      - soa-network

  grade-service:
    build: ./services/grade-service
    container_name: soa-grade-service
    ports:
      - "8000:8000"
    environment:
      DATABASE_URL: postgresql://grade_user:grade_pass@postgres:5432/grade_db
      JWT_SECRET: MyVerySecureSecretKeyForAuthenticationJWTTokens2024WithEnoughCharacters
      AUTH_SERVICE_URL: http://auth-service:8080
      PORT: 8000
    depends_on:
      - postgres
    networks:
      - soa-network

  billing-service:
    build: ./services/billing-service
    container_name: soa-billing-service
    ports:
      - "8081:8081"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/billing_db
      SPRING_DATASOURCE_USERNAME: billing_user
      SPRING_DATASOURCE_PASSWORD: billing_pass
      APP_JWT_SECRET: MyVerySecureSecretKeyForAuthenticationJWTTokens2024WithEnoughCharacters
      APP_JWT_EXPIRATION: 86400000
      PORT: 8081
    depends_on:
      - mysql
    networks:
      - soa-network

  auth-service:
    build: ./services/auth-service
    container_name: soa-auth-service
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/auth_db
      APP_JWT_SECRET: MyVerySecureSecretKeyForAuthenticationJWTTokens2024WithEnoughCharacters
      APP_JWT_EXPIRATION: 86400000
    depends_on:
      - mysql
    networks:
      - soa-network

  course-service:
    build: ./services/course-service
    container_name: soa-course-service
    ports:
      - "8082:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/course_db
      SPRING_DATASOURCE_USERNAME: course_user
      SPRING_DATASOURCE_PASSWORD: course_pass
      APP_JWT_SECRET: MyVerySecureSecretKeyForAuthenticationJWTTokens2024WithEnoughCharacters
      SERVER_PORT: 8082
    depends_on:
      - mysql
    networks:
      - soa-network

  payment-service:
    build: ./services/payment-service
    container_name: soa-payment-service
    ports:
      - "8083:8083"
    environment:
      DATABASE_URL: postgresql://payment_user:payment_pass@postgres-payment:5432/payment_db
      PORT: 8083
      # Payment Provider Credentials (PLACEHOLDERS)
      MYNITA_API_KEY: YOUR_MYNITA_API_KEY_HERE
      MYNITA_MERCHANT_ID: YOUR_MERCHANT_ID_HERE
      MYNITA_API_URL: https://api.mynita.ne/v1
      CARD_GATEWAY_API_KEY: YOUR_GATEWAY_API_KEY_HERE
      CARD_GATEWAY_SECRET: YOUR_GATEWAY_SECRET_HERE
    depends_on:
      - postgres-payment
    networks:
      - soa-network

  notification-service:
    build: ./services/notification-service
    container_name: soa-notification-service
    ports:
      - "8084:8084"
    environment:
      PORT: 8084
      MONGODB_URI: mongodb://mongodb:27017/notification_db
      # SMTP Configuration (PLACEHOLDERS)
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: your-email@gmail.com
      SMTP_PASS: your-app-password
      EMAIL_FROM: "Universit√© Niger <noreply@universite.ne>"
    depends_on:
      - mongodb
    networks:
      - soa-network

  frontend:
    build: ./FrontEnd
    container_name: soa-frontend
    ports:
      - "5173:5200"
    depends_on:
      - auth-service
      - student-service
      - grade-service
      - billing-service
      - course-service
      - payment-service
      - notification-service
      - ai-service
    networks:
      - soa-network

  ai-service:
    build: ./services/ai-service
    container_name: soa-ai-service
    ports:
      - "8086:8086"
    environment:
      PORT: 8086
      OPEN_ROUTER_KEY: ${OPEN_ROUTER_KEY}
      STUDENT_SERVICE_URL: http://student-service:3000
      COURSE_SERVICE_URL: http://course-service:8082
      GRADE_SERVICE_URL: http://grade-service:8000
    networks:
      - soa-network

  # Payment Database (separate Postgres instance)
  postgres-payment:
    image: postgres:15
    container_name: soa-postgres-payment
    ports:
      - "5431:5432"
    environment:
      POSTGRES_USER: payment_user
      POSTGRES_PASSWORD: payment_pass
      POSTGRES_DB: payment_db
    volumes:
      - postgres_payment_data:/var/lib/postgresql/data
      - ./services/postgres-payment-init:/docker-entrypoint-initdb.d
    networks:
      - soa-network

networks:
  soa-network:
    driver: bridge

volumes:
  mongodb_data:
  postgres_data:
  mysql_data:
  postgres_payment_data:
